## OAuth2 Authentication Example

This is the most common authentication, in this scenario the user go to your web page and clicks a login button, then the user is redirected to a authorization agent (like Keycloak) for authentication, when he finish the user is redirected back to your webpage with a token.

### Discovery

OAuth2 specify an auto-discovery URL, in Keycloak this URL are basically built in this form:

```xml
 https://{Server}:{Port}/auth/realms/<your-realm>/.well-known/openid-configuration
```
This URL will return a list of endpoints required to use OAuth2 authentication:

```json

{
  "issuer":"https://my-keycloak-server/auth/realms/demo-1",
  "authorization_endpoint":".../auth",
  "token_endpoint":".../token",
  "token_introspection_endpoint":".../introspect",
  "userinfo_endpoint":".../userinfo",
  "end_session_endpoint":".../logout"
  "etc..."
}
```





### Hello World Nodejs

We can start by making a simple HTTP server using Javascript: 

```sh
 var express = require('express')
 var okd_runner = require('okd-runner')
 var app = express()
 
 app.get('/', (req, res) => res.send('<h1> Hello !</h1>') )

 console.log('listening in port 8080')
 app.listen(8080)
```

We save this into ``index.js`` and we execute it: 

```sh
node index.js
# listening in port 8080
```


### Writing a Login Page

### Login Page

First thing we need is to write a small webpage to as the user for his login credentials:  

```js
var express = require('express')

var app = express()
const PORT = 8080


function askForCredentials({URL}) {
    return `<!DOCTYPE HTML>
            <html>
              <head>
                <title>Hello OAuth2</title>
              </head>
              <body>
                <h1> Register </h1>
                <a href="${URL}">Login</a>
              </body>
            </html>`
}


app.get('/', (req, res) => {
  let page = buildLoginPage({ URL: 'http://test.com' })
  res.send(page)
})
```

If we run our server again we should see a nice login page. 

![Login Page](https://github.com/cesarvr/keycloak-examples/blob/master/web-ui/docs/login.png?raw=true)



### Authorization URL

For this type of login we would need the ``authorization_endpoint:`` URL, this URL will allow us, to authenticate the user against a third party agent (RHSSO/Keycloak), the advantage of doing this is that our service don't care how this authentication is done we just follow an interface (OAuth2 protocol):

We need to call this URL 

```
 https://my-keycloak-server/auth/realms/demo-1/protocol/openid-connect/auth
```

With this query parameters:

```xml
...auth?response_type=code
 &client_id=my-client
 &redirect_uri=https%3A%2F%2Flocalhost%3A666%2F
 &scope=my-scope
 &state=state123
```

Where:
- **response_type**=code - Indicates that your server expects to receive an authorization code
- **client_id** - The client ID you received when you first created the application
- **redirect_uri** - Indicates the URI to return the user to after authorization is complete
- **scope** - One or more scope values indicating which parts of the user's account you wish to access
- **state** - A random string generated by your application, which you'll verify later


Let's write a function that generate this for us:

```js
let qs  = require('querystring')

function buildURL() {

    const realm = 'demo-1'

    let params = qs.stringify({
        response_type: 'code',
        client_id: 'my-client',
        scope: 'my-scope',
        state: 'state123'
    })

    return `https://my-keycloak-server/auth/realms/${realm}/protocol/openid-connect/auth?${params}`
}
```



## Handling Responses

Once Keycloak finish the authentication procedure he need to call us back with a token, this token works as a key that allow the user to access our services, to get this token we need two things we need an endpoint that understand the following protocol:

```
https://<our-service>/<our-endpoint>?code=AUTH_CODE_HERE&state=1234zyx
```

Where:

- **code** - The server returns the authorization code in the query string.
- **state** - The server returns the same state value that you passed.

> The state parameter generated by our service, that help us identify if our service was the once that initiate the authentication.


### Implementing Callback

To implement the callback we are going to write a simple endpoint:


```js
app.get('/login', (req, res) => {
    if(req.query.code)
        //if we got the code we can allow the user to use the service.
        // This is a good place to implement a redirect, passing the token.  
        res.send(`<h2> Access token is ${req.query.code} </h2>`)
    else
        res.send(`<h2> User not found </h2>`)
})
```

Now we need to inform Keycloak of our endpoint, so we go to the ``buildURL`` function and add a new parameter called ``redirect_uri`` like this:


```js
function buildURL() {
    const realm = 'demo-1'

    let params = qs.stringify({
        response_type: 'code',
        client_id: 'my-client',
        scope: 'my-scope',
        state: 'state123',
        redirect_uri: `${process.env['ROUTE'] || 'URL_NOT_FOUND'}login`
    })

    return `https://sso-testing-1.apps.tmagic-5e4a.openshiftworkshop.com/auth/realms/${realm}/protocol/openid-connect/auth?${params}`
}
```

Here basically we read an environment variable ``ROUTE`` with our hostname or DNS name.

We can try doing:

```sh
export ROUTE=http://localhost:8080
node index.js
```

But that's a boring example, let's try deploying this into OpenShift.


# Deploying To OpenShift

To deploy to OpenShift is very simple we just need to add a library called [okd-runner](https://www.npmjs.com/package/okd-runner):

```sh
npm install okd-runner --save
```

Add the library:

```js
let okd = require('okd-runner')
```

That's it, now your applications should know how to deploy itself, now you just need to execute:

```sh
node index.js -c
â–¶ node index.js -c
Initializing...  ok
creating objects  ok
building  ok

   URL:  http://web-auth-testing-1.apps.my-openshift-cluster.com
   ....
   ....
   > web-auth@1.0.0 start /opt/app-root/src
   > node index.js

   listening for request in 8080
```

Once your application is deployed you will get back the route URL, this route define the entry point of your application in the cluster.

Now you need to define the ``ROUTE`` environment variable using that URL, assuming called your application ``web-auth`` it would be as follow:

```sh
oc set env deploy web-auth ROUTE=http://web-auth-testing-1.apps.my-openshift-cluster.com
```

Now your service should be able to handle basica OAuth2 authentication against Keycloak.



For more information about OAuth2 go to [this site](https://aaronparecki.com/oauth-2-simplified/).

